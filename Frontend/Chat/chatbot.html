<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lawyer.AI Chat</title>
  <style>
    
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <div class="nav-left" onclick="toggleSidebar()">
        <div class="logo">
            <img src="https://i.pinimg.com/474x/8e/67/c1/8e67c148f79f24c1ffa129e791730a24.jpg" alt="LawyerAI">
            <span>LawyerAI</span>
        </div>
    </div>
    <!-- LANGUAGE DROPDOWN -->
    <div class="lang-dropdown">
      <button class="lang-btn">ЁЯМН Language тЦ╝ </button>
      <div class="lang-options">
        <div onclick="changeLanguage('en')">English</div>
        <div onclick="changeLanguage('hi')">рд╣рд┐рдиреНрджреА</div>
        <div onclick="changeLanguage('mr')">Marathi</div>
        <div onclick="changeLanguage('ta')">Tamil</div>
        <div onclick="changeLanguage('bn')">Bengali</div>
      </div>
    </div>
  </div>

  <!-- SIDEBAR / DASHBOARD -->
  <div class="sidebar" id="sidebar">
    <button onclick="goHome()">ЁЯПа Home</button>
    <button onclick="newChat()">тЮХ New Chat</button>
    <button onclick="showChatHistory()">ЁЯУЬ Chat History</button>
    <button class="clear-history" onclick="clearChatHistory()">ЁЯЧСя╕П Clear History</button>
    <div class="chat-history" id="chatHistoryList"></div>
  </div>

  <!-- CHAT INTERFACE -->
  <div class="chat-container">
    <div class="chat-box" id="chat-box">
      <div class="message ai-message" id="initialGreeting"></div>
    </div>
    <div class="input-container">
      <input type="text" id="user-input" placeholder="Type your question..." />
      <button onclick="sendMessage()">Send</button>
      <button id="mic-btn" onclick="startListening()">ЁЯОд</button>
    </div>
  </div>

  <script>
    // ---------- Global Variables ----------
    let selectedLanguage = 'en';
    let chatHistory = []; // stores past chat sessions; each session is an array of message objects
    let currentChat = []; // current session messages

    // Load chat history from localStorage if available
    function loadChatHistory() {
      const storedHistory = localStorage.getItem("chatHistory");
      if (storedHistory) {
        chatHistory = JSON.parse(storedHistory);
      }
    }
    loadChatHistory();

    // Save chat history to localStorage
    function saveChatHistory() {
      localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
    }

    // ---------- Set Initial Greeting Based on Language ----------
    function setInitialGreeting() {
      const greetingElem = document.getElementById("initialGreeting");
      let greeting = "";
      if (selectedLanguage === "hi") {
        greeting = "рдирдорд╕реНрдХрд╛рд░! рдЖрдЬ рдореИрдВ рдЖрдкрдХрд╛ рд╡рдХреАрд▓ рд╣реВрдБ! рдореИрдВ рдЖрдкрдХреА рдХреНрдпрд╛ рд╕рд╣рд╛рдпрддрд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ?";
      } else if (selectedLanguage === "mr") {
        greeting = "рдирдорд╕реНрдХрд╛рд░! рдЖрдЬ рдореА рддреБрдордЪрд╛ рд╡рдХреАрд▓ рдЖрд╣реЗ! рдореА рддреБрдореНрд╣рд╛рд▓рд╛ рдХрд╢реА рдорджрдд рдХрд░реВ рд╢рдХрддреЛ?";
      } else if (selectedLanguage === "ta") {
        greeting = "ро╡рогроХрпНроХроорпН! роЗройрпНро▒рпБ роиро╛ройрпН роЙроЩрпНроХро│рпН ро╡ро┤роХрпНроХро▒ро┐роЮро░ро╛роХ роЗро░рпБрокрпНрокрпЗройрпН! роиро╛ройрпН роЙроЩрпНроХро│рпБроХрпНроХрпБ роОрокрпНрокроЯро┐ роЙродро╡ роорпБроЯро┐ропрпБроорпН?";
      } else if (selectedLanguage === "bn") {
        greeting = "ржиржорж╕рзНржХрж╛рж░! ржЖржорж┐ ржЖржЬ ржЖржкржирж╛рж░ ржЙржХрж┐рж▓! ржЖржорж┐ ржХрж┐ржнрж╛ржмрзЗ ржЖржкржирж╛ржХрзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рждрзЗ ржкрж╛рж░рж┐?";
      } else {
        greeting = "Hello There! I will be your lawyer for today! How can I assist you ?";
      }
      document.getElementById("chat-box").innerHTML = `<div class="message ai-message">${greeting}</div>`;
    }
    setInitialGreeting();

    // ---------- Sidebar (Dashboard) Functions ----------
    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("show");
    }

    function goHome() {
      if (currentChat.length > 0) {
        chatHistory.push([...currentChat]);
        saveChatHistory();
        currentChat = [];
      }
      setInitialGreeting();
      toggleSidebar();
      // Redirect to home.html
      window.location.href = "home.html";
    }

    function newChat() {
      if (currentChat.length > 0) {
        chatHistory.push([...currentChat]);
        saveChatHistory();
      }
      currentChat = [];
      setInitialGreeting();
      toggleSidebar();
    }

    function showChatHistory() {
      const chatHistoryList = document.getElementById("chatHistoryList");
      chatHistoryList.innerHTML = "";
      if (chatHistory.length === 0) {
        chatHistoryList.textContent = "No previous chats.";
      } else {
        chatHistory.forEach((chat, index) => {
          const chatDiv = document.createElement("div");
          chatDiv.textContent = "Chat " + (index + 1);
          chatDiv.onclick = function () {
            loadChat(index);
          };
          chatHistoryList.appendChild(chatDiv);
        });
      }
    }

    function loadChat(index) {
      currentChat = chatHistory[index];
      const chatBox = document.getElementById("chat-box");
      chatBox.innerHTML = "";
      currentChat.forEach((msg) => {
        const msgDiv = document.createElement("div");
        msgDiv.className = "message " + (msg.sender === "user" ? "user-message" : "ai-message");
        msgDiv.textContent = msg.text;
        chatBox.appendChild(msgDiv);
      });
      toggleSidebar();
    }

    function clearChatHistory() {
      chatHistory = [];
      saveChatHistory();
      document.getElementById("chatHistoryList").innerHTML = "No previous chats.";
    }

    // ---------- Language Change Function ----------
    function changeLanguage(lang) {
      selectedLanguage = lang;
      currentChat = [];
      setInitialGreeting();
    }

    // ---------- Chat Functions ----------
    function sendMessage() {
      const inputField = document.getElementById("user-input");
      const chatBox = document.getElementById("chat-box");
      const userText = inputField.value.trim();
      if (!userText) return;
      
      // Append user message to chat box and update current chat
      const userMessageDiv = document.createElement("div");
      userMessageDiv.className = "message user-message";
      userMessageDiv.textContent = userText;
      chatBox.appendChild(userMessageDiv);
      currentChat.push({ sender: "user", text: userText });
      inputField.value = "";
      chatBox.scrollTop = chatBox.scrollHeight;
      
      // Prepare payload for the chatbot backend
      const payload = {
        message: userText,
        language: selectedLanguage,
      };

      // Send message to chatbot.py backend
      fetch("/chat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(payload),
      })
        .then((response) => response.json())
        .then((data) => {
          // Combine AI explanation with related legal sections if desired
          const aiResponse = data.ai_explanation || "(AI Response)";
          const related = data.related_sections ? "\n\nRelated Legal Sections:\n" + data.related_sections.join("\n") : "";
          const finalResponse = aiResponse + related;
          
          const aiMessageDiv = document.createElement("div");
          aiMessageDiv.className = "message ai-message";
          aiMessageDiv.textContent = finalResponse;
          chatBox.appendChild(aiMessageDiv);
          currentChat.push({ sender: "ai", text: finalResponse });
          chatBox.scrollTop = chatBox.scrollHeight;
        })
        .catch((err) => {
          console.error(err);
        });
    }

    // ---------- Voice-to-Text (Speech Recognition) ----------
    function startListening() {
      if (!("webkitSpeechRecognition" in window)) {
        alert("Speech Recognition is not supported in your browser. Please use Google Chrome.");
        return;
      }
      const recognition = new webkitSpeechRecognition();
      // Set language mapping
      const languageMap = {
        en: "en-IN",
        hi: "hi-IN",
        mr: "mr-IN",
        ta: "ta-IN",
        bn: "bn-BD"
      };
      recognition.lang = languageMap[selectedLanguage] || "en-IN";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onresult = function (event) {
        document.getElementById("user-input").value = event.results[0][0].transcript;
      };

      recognition.onerror = function (event) {
        console.error("Speech recognition error", event);
        alert("Speech recognition error: " + event.error);
      };

      recognition.start();
    }
  </script>
</body>
</html>
